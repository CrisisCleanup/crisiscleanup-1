{% if not mode_js %}
<!DOCTYPE html>
<html>

<head>
<title>Crisis Cleanup</title>
<link href="/stylesheets/form.css?v={{version}}" rel="stylesheet">
<link href="/stylesheets/form.print.css?v={{version}}" rel="stylesheet" type="text/css" media="print">
<link href="/stylesheets/default.css?v={{version}}" rel="stylesheet">
 <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.9.0/jquery.min.js"></script>   
 <script type="text/javascript" src="http://ajax.aspnetcdn.com/ajax/jquery.validate/1.11.1/jquery.validate.min.js"></script>   

<!-- <link href="/stylesheets/popup_radio_form.css" rel="stylesheet"> -->

  <link rel="stylesheet" href="/closure/css/autocomplete.css?v={{version}}">

{% if in_prod %}
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCv5oq0DwffOWKYK_tZBbOFguIcL22eF3c&v=3.exp&sensor=false"></script>
{% else %}
<script src="https://maps.googleapis.com/maps/api/js?v=3.exp&sensor=false"></script>
{% endif %}
{% if not_compiled %}
<script src="/closure/goog/base.js?v={{version}}"></script>
<script src="/javascript/deps.js?v={{version}}"></script>
<script type="text/javascript">
goog.require("sandy.form");
</script>
{% else %}
<script src="/javascript/compiled_form.js?v={{version}}">
{% endif %}
</script>
<script>

$(function(){


});
</script>
<script>
$(function(){
 $("#zip_code").one('focus', function() {
  var phase_id = $("#phase_id").val();
  var address = $("#address").val();
  var name = $("#name").val();
  
  console.log(phase_id);
  
  var obj = {
//     "zip": zip,
    "address": address,
    "name": name,
  }
  

  
  $.getJSON( "/check_similar_by_phase_api", obj)
    .done(function( data ) {
      var similar_phase = '<p>Similar site found for this phase.</p> \
	      <ul> \
	      <li>Name: " '+ data["name"] + '"</li>\
	      <li>City: " '+ data["city"] + '"</li>\
	      <li>Address: " '+ data["address"] + '"</li>\
	      </ul> \
	      <p>If this is the same site, click <a href="/edit?id=' + data["id"] + '">HERE</a> to edit the existing information.</p>';
	      
      var similar_site = '<p>Similar site found for this incident, but not for this phase.</p> \
	      <ul> \
	      <li>Name: " '+ data["name"] + '"</li>\
	      <li>City: " '+ data["city"] + '"</li>\
	      <li>Address: " '+ data["address"] + '"</li>\
	      </ul> \
	      <p>If this is the same site, click <a href="?site_id=' + data["id"] + '&phase_number=' + GetUrlValue("phase_number") + '">HERE</a> to edit the existing information.</p>';
	      

      console.log(data);
      if(data["phase_id"] == phase_id) {
	$("#similar_by_phase").append(similar_phase);
      } else {
	$("#similar_by_site").append(similar_site);

      }
    });
  
  });
});

function GetUrlValue(VarSearch){
    var SearchString = window.location.search.substring(1);
    var VariableArray = SearchString.split('&');
    for(var i = 0; i < VariableArray.length; i++){
        var KeyValuePair = VariableArray[i].split('=');
        if(KeyValuePair[0] == VarSearch){
            return KeyValuePair[1];
        }
    }
}
</script>

<script>
$(function(){
$("#submit_form").click(function() {
    $('#form').validate(
    {
    rules: {
      name: {
	minlength: 2,
	required: true
      },
    },
    //   highlight: function(element) {
    //     $(element).closest('.control-group').removeClass('success').addClass('error');
    //   },
    success: function(element) {
      alert(2);
    }
    });
    });
});
{% if post_json %}
$(function(){
var post_json = {{post_json}};
var oFormObject = document.forms['form'];

Object.keys(post_json).forEach(function(key) {
    var this_element = document.getElementById(key);
    var type = null;
//     try
//     {
//       var type = this_element.type;	
//       if (type == "text") {
// 	this_element.value = post_json[key];
//       }
//       if (type == "textarea") {
// 	this_element.value = post_json[key];
//       }
//       
//       if (type.indexOf("select") !== -1) {
// 	this_element.value = post_json[key];
//       }
//       if (type == "checkbox") {
//         if (post_json[key] == "y") {
// 	  this_element.checked = true;
// 	}
//       }
//       if (type == "radio") {
//         console.log(post_json[key]);
//         console.log(this_element);
// 	this_element.checked = true;
// 	$(':radio[value=' + post_json[key] + '][id=' + key + ']').click();
//       }
// 
//     }
//   catch(err)
//     {
// //       console.log("ERROR, ELEMENT = " + key + err + err.message);
//       
//     }

//     console.log(key, post_json[key]);
//     if (key == "name") {
//        var the_element = document.getElementById(key);
//        the_element.value = post_json[key];
//     }
});
})

{% endif %}


</script>
  <script>
	  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
	
	  ga('create', 'UA-42924421-1', 'crisiscleanup.org');
	  ga('send', 'pageview');
	
  </script>
</head>

<body onLoad="sandy.form.Initialize()">

<div id="form_background">
<div id="form">
{% if delete %}
<div class=delete_form>
  <form method=POST action="{{delete_post_url}}">
  <input type=hidden name=_id value="{{id}}">
  <input type=submit value="Permanently delete this site" class=delete_button>
  (this cannot be undone)
  </form>
</div>{# end delete_form #}
{% endif %}
<form id="incident_form" method="POST" action="{{page}}">
<div id="similar_by_site"></div>
  {{ hidden_site_id }}

{% endif %} {# not mode_js #}
<input type="hidden" name="event_name" value="{{event_name}}" />

{% if similar_site %}
  <section id="errors">
    <h1>Possible Duplicate</h1>
    <p>It looks like {{ similar_site.name }} ({{ similar_site.address }}) is already in the system.</p>
    <p><a href="/edit?id={{ similar_site.key().id() }}" target="_new_duplicate">Click here to open exisiting work order (in a new tab)</a></p>
    <input type="submit" onClick="document.getElementById('ignore_similar').checked=true;" value="Ignore &amp; Save">
  </section>
{% endif %}

{% if message %}
  <div class="form_message">
    {% if message_url %}
      <a href="{{ message_url }}">{{ message }}</a>
    {% else %}
      {{ message }}
    {% endif %}
  </div>
{% endif %}

{% if errors %}
<section id="errors">
  <header>The submission had errors</header>
  <article>
    <ul>
    {% for k in errors %}
      <li class="error">
        {% for e in errors[k] %}
          {{k}}: {{e}}
        {% endfor %}
      </li>
    {% endfor %}
    </ul>
  <article>
</section>
{% endif %}


<!-- <div id="similars"></div> -->
<div id="similar_by_phase"></div>

{{ single_site|safe }}

{% if id %}
<input type="hidden" name="_id" value="{{id}}">
{% endif %}
{% if not mode_js %}

{% if not delete %}
{% if id %}

{% else %}

<br>

{% endif %}
{% endif %}
</div>
</div>
</form>

{{ menubox }}

<div id="map_canvas"></div>
<div id="wrapper"></div>
<script>
function requestDate() {
Number.prototype.padLeft = function(base,chr){
    var  len = (String(base || 10).length - String(this).length)+1;
    return len > 0? new Array(len).join(chr || '0')+this : this;
}

var d = new Date,
    dformat = [d.getFullYear(),
     (d.getMonth()+1).padLeft(),
      d.getDate().padLeft()].join('-')+
              ' ' +
              [d.getHours().padLeft(),
               d.getMinutes().padLeft(),
               d.getSeconds().padLeft()].join(':');
document.getElementById('request_date').value = dformat;
}
requestDate();
</script>

{% include "_zendesk_scripts.html" %}

</body>
</html>
{% endif %} {# not mode_js #}
