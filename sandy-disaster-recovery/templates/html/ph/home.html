{% extends "base_template.html" %}

{% block home %}
class="active"
{% endblock %}



{% block head_content %}
<link rel="stylesheet" href="stylesheets/messi.css">
<link rel="stylesheet" href="assets/css/public-map.css">
{% endblock %}




{% block sidebar_content %}
    <div class="mister_roofer">
        <img src="assets/images/ph/TindogKitaGraphic.png" alt="" />
        <p>Tindog Kita,<br />Rising together after Typhoon Haiyan</p>
    </div>
    <div>
        <form id="site-filter" method="GET" role="form">
            {{ form.page }}
            <div class="form-group">
                <label for="date_from">From</label>
                <div class="datepicker input-group date form-group">
                    {{ form.date_from(class_='form-control input-sm') }}
                    <span class="input-group-addon"><i class="fa fa-calendar"></i></span>
                </div>
            </div>
            <span class="add-on"><i class="icon-calendar"></i></span>
            <div class="form-group">
                <label for="date_to">To</label>
                <div class="datepicker input-group date form-group">
                    {{ form.date_to(class_='form-control input-sm') }}
                    <span class="input-group-addon"><i class="fa fa-calendar"></i></span>
                </div>
            </div>
            <div class="form-group">
                <label for="county_and_state">Town/City</label>
                {{ form.county_and_state(class_='form-control input-sm') }}
            </div>
            <div class="form-group">
                <label for="order">Order</label><br />
                {{ form.order(class_='form-control input-sm') }}<br />
            </div>
            <strong>Categories</strong>
            <div id="site-filter-categories" class="checkbox">
                {{ form.work_type }}
            </div>
        </form>
    </div>

{% endblock %}

{% block main_content %}

    <div class="row">
        <div id="home-map" class="col-md-12">

            {#
            <h2>Incidents</h2>
            {% for event in events %}
            <p class="MapIncident" id="{{event.short_name}}">{{event.name}}</p>
            {% endfor %}
            #}

            <div id="display_incident" class="hidden"></div>
            <div id="display_filter"></div>
            <div id="map_canvas"></div>

        </div>
    </div>


    <div class="row">
        <div id="highchart_messagesday" class="col-md-12"></div>
    </div>

    <div class="row">
        <div id="home-messages" class="col-md-12">
            {%- macro previous_and_next() -%}
            <p>
                {% if form.page.data %}
                [<a href="#" class="change-page" data-change="-1">Previous Page</a>]
                {% endif %}

                {% if sites|length == sites_per_page %}
                [<a href='#' class="change-page" data-change="+1">Next Page</a>]
                {% endif %}
            </p>
            {%- endmacro -%}

            {{ previous_and_next() }}

            <table id="home-table" class="table table-striped">
                <thead>
                <tr id="order-from-table">
                    <th><a data-field="request_date">Date {% if form.order.data == 'request_date' %}<i class="fa fa-angle-up"></i>{% elif form.order.data == '-request_date' %}<i class="fa fa-angle-down"></i>{% endif %}</a></th>
                    {% if logged_in %}
                        <th>Name</th>
                        <th>Gender</th>
                        <th>Responses</th>
                    {% endif %}

                    <th><a data-field="work_type">Category {% if form.order.data == 'work_type' %}<i class="fa fa-angle-up"></i>{% elif form.order.data == '-work_type' %}<i class="fa fa-angle-down"></i>{% endif %}</a></th>
                    <th><a data-field="message_type">Type {% if form.order.data == 'message_type' %}<i class="fa fa-angle-up"></i>{% elif form.order.data == '-message_type' %}<i class="fa fa-angle-down"></i>{% endif %}</a></th>
                    <th>Message</th>
                    <th><a data-field="county">Town {% if form.order.data == 'county' %}<i class="fa fa-angle-up"></i>{% elif form.order.data == '-county' %}<i class="fa fa-angle-down"></i>{% endif %}</a></th>
                    <th><a data-field="state">Region {% if form.order.data == 'state' %}<i class="fa fa-angle-up"></i>{% elif form.order.data == '-state' %}<i class="fa fa-angle-down"></i>{% endif %}</a></th>
                    {% if logged_in %}
                        <th></th>
                    {% endif %}
                </tr>
                </thead>
                <tbody>
                {% for site in sites %}
                <tr>
                    <td>{{ site.request_date.strftime('%m/%d/%Y') }}</td>
                    {% if logged_in %}
                        <td>{{ site.name }}</td>
                        <td>{{ site.gender }}</td>
                        <td>{% if site.correct == 'y' %}correct{% endif %}</td>
                    {% endif %}
                    <td>{{ site.work_type }}</td>
                    <td>{{ site.message_type }}</td>
                    <td>{{ site.message|truncate(100) }}</td>
                    <td>{{ site.county }}</td>
                    <td>{{ site.state }}</td>
                    {% if logged_in %}
                        <td>
                            [<a href="/edit?id={{ site.key().id() }}">Edit</a>]
                            {###### [<a href="/delete?id={{ site.key().id() }}">Delete</a>] #}
                        </td>
                    {% endif %}
                </tr>
                {% endfor %}
                </tbody>
            </table>

            {{ previous_and_next() }}

            {#
            <p class="pull-right">
                <a href="/export">Download (CSV)</a>
            </p>
            #}

        </div>
    </div>
{% endblock %}









{% block scripts %}

<script src="/closure/goog/base.js?v={{version}}"></script>
<script src="/javascript/deps.js?v={{version}}"></script>
<script type="text/javascript">
    goog.require("sandy.{% if demo %}demo{% else %}main{% endif %}");
</script>

<script>window.jQuery || document.write('<script src="assets/js/libs/jquery-1.11.0.min.js"><\/script>')</script>

<script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?sensor=false"></script>

<script type="text/javascript" src="assets/js/libs/highcharts/highcharts.js"></script>

<script type="text/javascript" src="javascript/ph/home_map.js"></script>

<script type="text/javascript" src="javascript/map_clusterer.js"></script>
<script type="text/javascript" src="javascript/messi.js"></script>

<script type="text/javascript">
    $(function() {

        // datetimepicker
        $('.datepicker').datetimepicker({
            format: 'MM/dd/yyyy',
            pickTime: false
            })
            .on('changeDate', function(ev){
                $('form#site-filter').submit()
            });


        // populate map
        $(document).ready(function() {
            clusterer.clearMarkers();

            var work_type = $('input[name=work_type]:checked').map(function() {
                return this.value;
            }).get().join(',');
            var date_from = $('#date_from').val()
            var date_to = $('#date_to').val()
            var county_and_state = $('#county_and_state').val()
            populateMapByIncident('yolanda', 0, work_type, county_and_state, date_from, date_to, []);
        });


        // show wait cursor when form is submitted
        $('form').on('submit', function() {
            $('body').addClass('wait-cursor');
        });

        // submit form
        $('select').change(function() {
            $('form#site-filter').submit()
        });
        $('input[type=checkbox]').change(function() {
            $('form#site-filter').submit()
        });

        // submit form on click of prev or next links
        $('a.change-page').click(function() {
            var newPageNum = {{ form.page.data }} + parseInt($(this).attr('data-change'));
            $('input[name=page]').val(newPageNum);
            $('form#site-filter').submit();
        });


        // order from table
        $('#order-from-table a').click(function(e) {
            e.preventDefault();
            var field = $(this).data('field');
            if ($('#order').find(":selected").val() == field)
                field = '-'+field;
            $('#order').val(field);
            $('form#site-filter').submit();
        });


        // highcharts
        $(function () {


            $('#highchart_messagesday').highcharts({
                chart: {
                    height: 200,
                    type: 'line'
                },
                title: {
                    text: 'Communications Received per Day',
                    x: 0
                },
                xAxis: {
                    type: 'datetime',
                    dateTimeLabelFormats: {
                        month: '%e %b',
                        year: '%b'
                    }
                },
                yAxis: {
                    allowDecimals:false,
                    title: {
                        text: 'Messages'
                    },
                },
                legend: {
                    enabled: false
                },
                series: [{
                    name: 'Messages',
                    data: [{% for chart_day, chart_message in chart_messages.iteritems() %}[Date.UTC({{chart_day}}), {{chart_message}}],{% endfor %}]
                }]
            });
        });



    });

</script>
{% endblock %}










        {#
{% block banner %}
   <article role="main" class="clearfix">
       <div class="post">
         {{ home_banner_page_block|safe }}
       </div>
   </article>
{% endblock %}

{% block description_title %}
{{ home_description_title_page_block|safe }}
{% endblock %}

{% block description_subtitle %}
{{ home_description_subtitle_page_block|safe }}
{% endblock %}

{% block sidebar_title %}
{{ home_sidebar_title_page_block|safe}}
{% endblock %}

{% block sidebar_content %}
{{ home_sidebar_content_page_block|safe }}
{% endblock %}

{% block main_title %}
{{ home_main_title_page_block|safe }}
{% endblock %}

{% block main_content %}
{{ home_main_content_page_block|safe }}
{% endblock %}
        #}
